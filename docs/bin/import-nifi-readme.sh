#!/bin/bash
#
# Import several README.md files from the GeoMesa nifi distribution,
# using ``pandoc`` to convert Markdown to RST.
#
# ----------------------------------------------------------------------
# WARNING: This is not completely automated. You will almost certainly
# have to hand-edit the files after this import!
# ----------------------------------------------------------------------

# default paths
# may be overridden by setting variables or by command line switches
# (will try to guess $GEOMESA relative to the script path)
GEOMESA=${GEOMESA:-$(readlink -f "$(dirname ${BASH_SOURCE[0]})/../..")}
GEOMESA_NIFI=${GEOMESA_NIFI:-/path/to/geomesa-nifi}

function usage {
    echo "$0: imports several README.md files from the GeoMesa Nifi distribution,"
    echo "using pandoc to convert Markdown to RST."
    echo
    echo "usage: $0 [options] [<tutorials-to-copy>]"
    echo
    echo "If <tutorials-to-copy> is omitted, all tutorials will be copied."
    echo
    echo "options:"
    echo "  --gm <dir>     set \$GEOMESA [$GEOMESA]"
    echo "  --nifi <dir>    set \$GEOMESA_NIFI [$GEOMESA_NIFI]"
}

# parse options
while :
do
   case "$1" in
       --gm)
           GEOMESA="$2"
           shift 2
           ;;
       --nifi)
           GEOMESA_NIFI="$2"
           shift 2
           ;;
       -h | --help)
           usage
           exit 1
           ;;
       --) # manual end of options
           break
           ;;
       -*)
           echo "ERROR: unknown option $1" >&2
           exit 2
           ;;
       *) # end of options
           break
           ;;
   esac
done

# load functions
source $GEOMESA/docs/bin/common.sh
if [[ "$?" != 0 ]] ; then
    echo "ERROR: can't source common.sh"
    exit 1
fi

# check repos
check_repo $GEOMESA git@github.com:locationtech/geomesa.git
check_repo $GEOMESA_NIFI git@github.com:geomesa/geomesa-nifi.git

echo "## Nifi:"

# copy the README.md file
text_src=$GEOMESA_NIFI/README.md
text_dst=$GEOMESA/docs/user/nifi.rst
echo "Converting $text_src => $text_dst"
pandoc -i $text_src -o $text_dst

# fix links and bad RST generated by pandoc
echo "Fixing links and bad RST"
sed -i -e 's/.. code::/.. code-block::/' $text_dst
